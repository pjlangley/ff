name: core fragments

on:
  push:
    branches:
      - main

jobs:
  ff_node:
    runs-on: ubuntu-latest
    name: node.js
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - uses: ./.github/actions/nodejs_docker_build
      - name: store solana program keys into environment variables
        run: cat program_keys.env >> $GITHUB_ENV
      - name: start fastify api
        run: |
          docker run -d \
            --name fastify \
            --network ci-network \
            -p 3000:3000 \
            -e FASTIFY_HOST=0.0.0.0 \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SOLANA_HOST=solana \
            -e counter_PROGRAM_ID=$counter_PROGRAM_ID \
            -e username_PROGRAM_ID=$username_PROGRAM_ID \
            -e round_PROGRAM_ID=$round_PROGRAM_ID \
            ff_node 
      - name: unit tests
        run: |
          docker run --rm \
            --network ci-network \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SOLANA_HOST=solana \
            -e counter_PROGRAM_ID=$counter_PROGRAM_ID \
            -e username_PROGRAM_ID=$username_PROGRAM_ID \
            -e round_PROGRAM_ID=$round_PROGRAM_ID \
            ff_node \
            --run test
      - name: bruno integration tests for fastify api
        run: |
          docker run --rm \
            --network ci-network \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SOLANA_HOST=solana \
            ff_node \
            --run api:bru:fastify:docker
      - name: lint
        run: docker run --rm ff_node --run lint
      - name: typescript check
        run: docker run --rm ff_node --run tsc
      - name: format check
        run: docker run --rm ff_node --run format:check

  ff_python:
    runs-on: ubuntu-latest
    name: python
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - name: store solana program keys into environment variables
        run: cat program_keys.env >> $GITHUB_ENV
      - run: |
          docker build \
            --force-rm \
            --build-arg PYTHON_VERSION=3.12.4 \
            -f docker.python.Dockerfile \
            -t ff_python .
      - name: run all fragments
        run: |
          docker run --rm \
            --network ci-network \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SOLANA_HOST=solana \
            ff_python
      - name: unit tests
        run: |
          docker run --rm \
            --network ci-network \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SOLANA_HOST=solana \
            -e counter_PROGRAM_ID=$counter_PROGRAM_ID \
            -e username_PROGRAM_ID=$username_PROGRAM_ID \
            -e round_PROGRAM_ID=$round_PROGRAM_ID \
            ff_python \
            -m unittest -v --failfast
      - name: type check
        run: docker run --rm --entrypoint mypy ff_python --config-file mypy.ini
      - name: lint
        run: docker run --rm --entrypoint pylint ff_python ./fragments --rcfile ./pylintrc
      - name: format check
        run: docker run --rm --entrypoint black ff_python ./fragments --check

  ff_rust:
    runs-on: ubuntu-latest
    name: rust
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: store solana program keys into environment variables
        run: cat program_keys.env >> $GITHUB_ENV

      - uses: moonrepo/setup-rust@v1
        with:
          inherit-toolchain: true

      - name: lint
        run: cargo clippy -- -D warnings

      - name: format check
        run : cargo fmt -v --check

      - name: unit tests
        run: cargo test -- --test-threads=1

      - name: build
        run: cargo build --bin api

      - name: run axum api
        run: ./target/debug/api &

      - uses: actions/setup-node@v6
        with:
          node-version: 22.x
          cache: 'npm'

      - name: install npm dependencies
        run: npm ci

      - name: bruno integration tests for axum api
        run: node --run api:bru:axum

      - name: disk space before cleanup
        run: |
          df -h
          docker system df

      - name: Docker cleanup (frees disk space for moonrepo caching)
        run: |
          docker ps -aq | xargs -r docker rm -f
          docker images -aq | xargs -r docker rmi -f
          docker system prune -af || true

      - name: disk space after cleanup
        run: |
          df -h
          docker system df

  ff_go:
    runs-on: ubuntu-latest
    name: go
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - uses: ./.github/actions/nodejs_docker_build
      - name: store solana program keys into environment variables
        run: cat program_keys.env >> $GITHUB_ENV
      - run: |
          docker build \
            --force-rm \
            --build-arg GO_VERSION=1.23.1 \
            --build-arg ALPINE_VERSION=3.20 \
            --build-arg GO_CI_LINT_VERSION=1.61.0 \
            -f docker.go.Dockerfile \
            -t ff_go .
      - name: start gin api
        run: |
          docker run -d \
            --name gin \
            --network ci-network \
            -p 3002:3002 \
            -e GIN_HOST=0.0.0.0 \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SOLANA_HOST=solana \
            -e counter_PROGRAM_ID=$counter_PROGRAM_ID \
            -e username_PROGRAM_ID=$username_PROGRAM_ID \
            -e round_PROGRAM_ID=$round_PROGRAM_ID \
            ff_go
      - name: unit tests
        run: |
          docker run --rm \
            --network ci-network \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SOLANA_HOST=solana \
            -e counter_PROGRAM_ID=$counter_PROGRAM_ID \
            -e username_PROGRAM_ID=$username_PROGRAM_ID \
            -e round_PROGRAM_ID=$round_PROGRAM_ID \
            --entrypoint go \
            ff_go \
            test -v -p 1 ./fragments/...
      - name: bruno integration tests for gin api
        run: |
          docker run --rm \
            --network ci-network \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SOLANA_HOST=solana \
            ff_node \
            --run api:bru:gin:docker
      - name: lint
        run: docker run --rm --entrypoint golangci-lint ff_go run -v ./fragments/...
      - name: format check
        run: docker run --rm --entrypoint test ff_go -z $(gofmt -l ./fragments)